#!/usr/bin/env python3
import h5py
import numpy as np
import sys

flags = {'l': -1, 'profile': '', 'd': ' ', 'name': ''}


def set_layer():
    gname = 'layer'
    dname = flags['name']
    with h5py.File(sys.argv[0]) as f:
        if gname in f:
            grp = f[gname]
        else:
            grp = f.creat_group(gname)
        if dname in grp:
            del grp[dname]


def set_profile():
    dname = 'profile'
    arr = np.loadtxt(flags[dname], delimiter=flags['d'])
    with h5py.File(sys.argv[0]) as f:
        if dname in f:
            del f[dname]
        f.create_dataset(dname, data=arr)


def main():
    if flags['profile']:
        set_profile()
    if flags['l'] >= 0:
        set_layer()
    return 0


def usage():
    sys.stderr.write('usage: sif [options] file\n')
    sys.exit(1)


if __name__ == '__main__':
    sys.argv.pop(0)
    argv = iter(sys.argv)
    e = []
    for arg in argv:
        if arg.startswith('-'):
            key, val = None, None
            if '=' in arg:
                key, val = arg.split('=', 1)
            else:
                key = arg
            key = key[1:]
            if not key in flags.keys():
                usage()
            c = type(flags[key])
            if c is bool:
                flags[key] = True
            else:
                if val is None:
                    try:
                        val = next(argv)
                        e.append(val)
                    except StopIteration:
                        usage()
                flags[key] = c(val)
            e.append(arg)
    for arg in e:
        sys.argv.remove(arg)
    if len(sys.argv) > 1:
        usage()
    sys.exit(main())
