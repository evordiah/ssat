#!/usr/bin/python3 -W ignore
import importlib
import os
import pkgutil
import shlex
import sys

import ssat
from ssat import *

description = """usage: ssat cfgfile command...
commands are:
"""
rc = {}


def usage():
    die(description)


if __name__ == '__main__':
    if len(sys.argv) < 3:
        usage()

    for i, mod, ispkg in pkgutil.iter_modules(ssat.__path__):
        if not ispkg:
            m = importlib.import_module('..' + mod, package='ssat.__init__')
            rc[mod] = m.main
            description += '\t{}: {}\n'.format(mod, m.description)

    with open(sys.argv.pop(1)) as f:
        for tok in shlex.split(f.read(), comments=True):
            key, val = tuple(tok.split('=', 2))
            if key not in cfg.keys():
                die('invalid config file.')
            try:
                cfg[key] = type(cfg[key])(val)
            except ValueError:
                die('invalid config file.')
    ret = 1
    while len(sys.argv) > 1:
        cmd = sys.argv.pop(1)
        sys.argv[0] = cmd
        if cmd not in rc.keys():
            usage()
        ret = rc[cmd]()
        if ret == 1:
            ret = 0
            break
        elif ret < 0:
            die(cmd + ' returned non-zero exit status.')
    sys.exit(ret)
