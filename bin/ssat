#!/usr/bin/python3 -W ignore
import importlib
import os
import pkgutil
import shlex
import sys

import ssat
from ssat import *

usage = """usage: ssat cfgfile command...
commands are:
"""
rc = {}


if __name__ == '__main__':
    if len(sys.argv) < 3:
        die(usage)

    for i, mod, ispkg in pkgutil.iter_modules(ssat.__path__):
        if not ispkg:
            m = importlib.import_module('..' + mod, package='ssat.__init__')
            rc[mod] = m.main
            usage += '\t{}: {}\n'.format(mod, m.__doc__)

    with open(sys.argv.pop(1)) as f:
        for tok in shlex.split(f.read(), comments=True):
            key, val = tuple(tok.split('=', 2))
            if key not in cfg.keys():
                die('invalid config file.')
            try:
                cfg[key] = type(cfg[key])(val)
            except ValueError:
                die('invalid config file.')
    while len(sys.argv) > 1:
        cmd = sys.argv.pop(1)
        sys.argv[0] = cmd
        if cmd not in rc.keys():
            die(usage)
        exit_status = rc[cmd]()
        if exit_status == 1:
            sys.exit(0)
            # not reached
        if exit_status < 0:
            die(cmd + ' returned non-zero exit status.')
            # not reached
    sys.exit(0)
